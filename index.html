<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ooru Mess | Digital Ordering v3</title>
    
    <!-- ICON CONFIGURATION -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçõ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; touch-action: manipulation; }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .pulse-status { animation: pulse-green 2s infinite; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom utility for dynamic viewport height */
        .h-dvh { height: 100vh; height: 100dvh; }
        
        /* Compact Item Button Styles */
        .item-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .item-btn:active {
            transform: scale(0.96);
        }
    /* --- Landing Page Styles --- */
        .landing-screen {
            position: fixed;
            inset: 0;
            background: #FFF8F0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .landing-pattern {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(#fdba74 1px, transparent 1px);
            background-size: 24px 24px;
            opacity: 0.2;
            pointer-events: none;
        }
        
        /* 3D Button Style for Landing */
        .btn-3d {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            user-select: none;
            transform: translateY(0);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 transparent !important;
        }
        .btn-orange {
            background: linear-gradient(180deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 4px 0 #c2410c;
        }
        .btn-green {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 0 #047857;
        }

        /* Prevent text chopping */
        button, .truncate {
            white-space: nowrap;
        }
    

        /* ===== Landing: responsive button placement (Portrait bottom, Landscape right) ===== */
        .landing-logo { width: 100%; }
        .landing-actions { width: 100%; max-width: 28rem; } /* ~ max-w-md */

        @media screen and (orientation: landscape) {
            /* Use layout (not fixed positioning) to avoid overlapping the logo */
            .landing-screen {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 24px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-top: max(16px, env(safe-area-inset-top));
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
            .landing-logo {
                flex: 1 1 auto;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 0;
            }
            .landing-actions {
                flex: 0 0 auto;
                width: min(420px, 42vw);
                max-width: 420px;
                margin-bottom: 0 !important;
            }
            .landing-actions button {
                padding-top: 0.9rem;
                padding-bottom: 0.9rem;
                font-size: 1.05rem;
            }
        }



/* ===== Landing Page Button Size Refinement ===== */
.landing-actions button {
    max-width: 320px;
    padding-top: 14px;
    padding-bottom: 14px;
    font-size: 1rem;
}

/* Portrait ‚Äì keep centered */
@media (orientation: portrait) {
    .landing-actions {
        align-items: center;
    }
}

/* Landscape ‚Äì slightly tighter */
@media (orientation: landscape) {
    .landing-actions button {
        max-width: 300px;
    }
}




.landing-actions button{
    margin-left: auto;
    margin-right: auto;
}


/* ===== Restore Stacked Buttons & Center Them ===== */
.landing-actions{
    display: flex;
    flex-direction: column;   /* restore vertical stack */
    align-items: center;      /* center horizontally */
    justify-content: center;
}

.landing-actions button{
    margin-left: auto;
    margin-right: auto;
}

#qrcode img {
    margin: 0 auto;
    display: block;
}

</style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, writeBatch, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAT-Q_8g-JHlE4GCPj4JjwgaOf7_fjWj0Y",
            authDomain: "ooru-mess.firebaseapp.com",
            projectId: "ooru-mess",
            storageBucket: "ooru-mess.firebasestorage.app",
            messagingSenderId: "416498252793",
            appId: "1:416498252793:web:76d610bdb967953fb75b28",
            measurementId: "G-D7SXMP1YS2"
        };

        // --- DuitNow Logic ---
        
        // CRC16 Checksum Calculator
        function generateCRC16(str) {
            let crc = 0xFFFF;
            for (let c = 0; c < str.length; c++) {
                crc ^= str.charCodeAt(c) << 8;
                for (let i = 0; i < 8; i++) {
                    if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
                    else crc = crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }

        // Generate Dynamic DuitNow String
        function generateDuitNowString(baseString, amount) {
            if (!baseString) return null;
            baseString = baseString.trim();

            let objects = {};
            let i = 0;
            try {
                while (i < baseString.length) {
                    let id = baseString.substr(i, 2);
                    let len = parseInt(baseString.substr(i + 2, 2));
                    let val = baseString.substr(i + 4, len);
                    objects[id] = val;
                    i += 4 + len;
                }
            } catch (e) {
                console.error("Error parsing base QR string:", e);
                return null;
            }
            
            // Force Dynamic
            objects['01'] = '12';
            objects['54'] = parseFloat(amount).toFixed(2);
            if (!objects['53']) objects['53'] = '458';
            if (!objects['58']) objects['58'] = 'MY';

            const keys = Object.keys(objects).filter(k => k !== '63').sort();
            
            let newString = '';
            for (let k of keys) {
                let val = objects[k];
                let len = val.length.toString().padStart(2, '0');
                newString += k + len + val;
            }
            newString += '6304';
            const crc = generateCRC16(newString);
            newString += crc;
            
            return newString;
        }

        // --- Default Data for Seeding ---
        const DEFAULT_CATEGORIES = [
            { id: 'cat1', name: 'Banana Leaf', order: 1 },
            { id: 'cat2', name: 'Student Sets', order: 2 },
            { id: 'cat3', name: 'Thinnai Time', order: 3 },
            { id: 'cat4', name: 'Beverages', order: 4 },
            { id: 'cat5', name: 'Add-ons', order: 5 }
        ];

        const DEFAULT_MENU = [
            { name: 'Banana Leaf Set', variant: 'Vegetarian', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Chicken', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Mutton', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Fish', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Prawn', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Squid', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Tauhu + Potato', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Tauhu + MealMaker', category: 'Banana Leaf', price: 14.9 },
            { name: 'Banana Leaf Set', variant: 'Mealmaker + Potato', category: 'Banana Leaf', price: 14.9 },
            { name: 'Student Set', variant: 'Vegetarian', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Chicken', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Mutton', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Fish', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Prawn', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Squid', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Tauhu + Potato', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Tauhu + MealMaker', category: 'Student Sets', price: 12.9 },
            { name: 'Student Set', variant: 'Mealmaker + Potato', category: 'Student Sets', price: 12.9 },
            { name: 'Vadai Set', variant: '', category: 'Thinnai Time', price: 5 },
            { name: 'Vadai', variant: 'Single', category: 'Thinnai Time', price: 1.7 },
            { name: 'Aloo Bonda', variant: '', category: 'Thinnai Time', price: 2 },
            { name: 'Idli Set', variant: '', category: 'Thinnai Time', price: 5 },
            { name: 'Idiyappam Set', variant: '', category: 'Thinnai Time', price: 5 },
            { name: 'Egg Bonda', variant: '', category: 'Thinnai Time', price: 2.5 },
            { name: 'Chappati Set', variant: '', category: 'Thinnai Time', price: 5 },
            { name: 'Drink Of The Day', variant: '', category: 'Beverages', price: 0 },
            { name: 'Coke', variant: '', category: 'Beverages', price: 2.5 },
            { name: 'Thinnai Tea', variant: '', category: 'Beverages', price: 5 },
            { name: 'Thinnai Coffee', variant: '', category: 'Beverages', price: 5 },
            { name: 'Chicken Add-On', variant: '', category: 'Add-ons', price: 2 },
            { name: 'Mutton Add-On', variant: '', category: 'Add-ons', price: 3 },
            { name: 'Fish Add-On', variant: '', category: 'Add-ons', price: 4 },
            { name: 'Prawn Add-On', variant: '', category: 'Add-ons', price: 4 },
            { name: 'Veg Add-On', variant: '', category: 'Add-ons', price: 2 },
            { name: 'Kids Meal', variant: '', category: 'Add-ons', price: 5 },
        ];

        // --- State Management ---
        const state = {
            view: 'landing', 
            user: null,
            orders: [],
            cart: [],
            menuItems: [],
            categories: [],
            activeCategory: 'Banana Leaf',
            isCheckoutOpen: false,
            isConfirmationOpen: false, 
            isPaymentOpen: false,
            paymentStep: 'selection', 
            isAdminLoginOpen: false,
            tableNumber: '',
            isDemoMode: false,
            loading: true,
            error: null,
            adminPin: '',
            adminAuthenticated: false,
            adminLoginError: '', 
            adminExpandedCategories: {},
            tabTotal: 0,
            checkoutMode: 'cart',
            duitNowBaseString: '',
            testQRString: null,
            processingAction: null // NEW: Tracks active loading state
        };

        // --- Initialization ---
        let app, auth, db;
        
        async function init() {
            if (window.location.protocol === 'file:') {
                handleError({
                    code: 'protocol-error',
                    message: 'Security Warning: File protocol detected. Please host on GitHub Pages or local server.'
                });
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                try { getAnalytics(app); } catch(e) {}
                
                auth = getAuth(app);
                db = getFirestore(app);
                
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.user = user;
                        setupDataListeners();
                    }
                });
            } catch (error) {
                handleError(error);
            }
        }

        function handleError(error) {
            console.warn("App Error:", error);
            state.loading = false;
            state.error = error;
            render();
        }

        function setupDataListeners() {
            if (state.isDemoMode) {
                state.categories = DEFAULT_CATEGORIES;
                state.menuItems = DEFAULT_MENU.map((item, i) => ({...item, id: 'demo'+i}));
                state.orders = [];
                state.loading = false;
                render();
                return;
            }

            const basePath = "artifacts/ooru-mess-github/public/data";

            onSnapshot(query(collection(db, basePath, "categories"), orderBy("order")), (snap) => {
                const rawCategories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const uniqueCategories = [];
                const seenNames = new Set();
                rawCategories.forEach(cat => {
                    const normalizedName = cat.name.trim().toLowerCase();
                    if (!seenNames.has(normalizedName)) {
                        seenNames.add(normalizedName);
                        uniqueCategories.push(cat);
                    }
                });
                state.categories = uniqueCategories;

                if(state.categories.length === 0) {
                    seedDatabase(); 
                } else if (!state.activeCategory && state.categories.length > 0) {
                    state.activeCategory = state.categories[0].name;
                }
                render();
            });

            onSnapshot(collection(db, basePath, "menu"), (snap) => {
                state.menuItems = snap.docs.map(d => ({id: d.id, ...d.data()}));
                state.loading = false;
                render();
            });

            onSnapshot(doc(db, basePath, "settings", "payment"), (docSnap) => {
                if (docSnap.exists()) {
                    state.duitNowBaseString = docSnap.data().duitNowString || '';
                }
                render(); 
            });

            onSnapshot(query(collection(db, basePath, "orders"), orderBy("timestamp", "desc")), (snap) => {
                state.orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.view === 'kitchen') render();
                if (state.isCheckoutOpen && state.tableNumber) {
                     setTableNumber(state.tableNumber);
                }
            }, (err) => {
                if (err.code === 'permission-denied') {
                    handleError({code: 'permission-denied', message: 'Permission Denied.'});
                }
            });
        }

        async function seedDatabase() {
            const basePath = "artifacts/ooru-mess-github/public/data";
            const batch = writeBatch(db);
            DEFAULT_CATEGORIES.forEach(cat => batch.set(doc(collection(db, basePath, "categories")), cat));
            DEFAULT_MENU.forEach(item => batch.set(doc(collection(db, basePath, "menu")), item));
            await batch.commit();
        }

        // --- Actions ---

        window.setView = (viewName) => {
            if (viewName === 'admin' && !state.adminAuthenticated) {
                state.isAdminLoginOpen = true;
                state.adminLoginError = ''; 
                render();
                return;
            }
            state.view = viewName;
            render();
        };

        window.closeAdminLogin = () => {
            state.isAdminLoginOpen = false;
            state.adminLoginError = '';
            render();
        };

        window.handleAdminLogin = (e) => {
            e.preventDefault();
            const pin = document.getElementById('adminPinInput').value;
            if (pin === "1234") {
                state.adminAuthenticated = true;
                state.isAdminLoginOpen = false;
                state.view = 'admin';
            } else {
                state.adminLoginError = 'Incorrect PIN';
                const container = document.getElementById('pinContainer');
                container.classList.remove('animate-shake');
                void container.offsetWidth; 
                container.classList.add('animate-shake');
            }
            render();
        };

        window.saveDuitNowString = async () => {
            const val = document.getElementById('duitNowInput').value.trim();
            if (!val) return;
            try {
                const basePath = "artifacts/ooru-mess-github/public/data";
                await setDoc(doc(db, basePath, "settings", "payment"), {
                    duitNowString: val
                }, { merge: true });
                alert("DuitNow settings saved! QR codes will now be dynamic.");
            } catch (e) {
                console.error(e);
                alert("Error saving settings.");
            }
        };
        
        window.testDuitNowQR = () => {
            const val = document.getElementById('duitNowInput').value.trim();
            if (!val) { alert("Please paste a string first."); return; }
            const dynamicString = generateDuitNowString(val, 1.00);
            if (!dynamicString) { alert("Failed to generate QR. Check string format."); return; }
            state.testQRString = dynamicString;
            render();
            setTimeout(() => {
                const container = document.getElementById('testQROutput');
                if (container) {
                    container.innerHTML = '';
                    new QRCode(container, { text: dynamicString, width: 150, height: 150 });
                }
            }, 100);
        };

        window.setCategory = (cat) => {
            state.activeCategory = cat;
            render();
        };

        window.addToCart = (itemId) => {
            const item = state.menuItems.find(i => i.id === itemId);
            const existing = state.cart.find(i => i.id === itemId);
            if (existing) { existing.quantity++; } else { state.cart.push({ ...item, quantity: 1 }); }
            render();
        };

        window.updateQuantity = (itemId, change) => {
            const item = state.cart.find(i => i.id === itemId);
            if (!item) return;
            item.quantity += change;
            if (item.quantity <= 0) {
                state.cart = state.cart.filter(i => i.id !== itemId);
            }
            render();
        };

        window.toggleCheckout = (isOpen, mode = null) => {
            state.isCheckoutOpen = isOpen;
            if (isOpen) state.checkoutMode = mode || state.checkoutMode || 'cart';
            render();
            if (isOpen && state.tableNumber) {
                setTimeout(() => setTableNumber(state.tableNumber), 50);
            }
        };
        
        window.togglePayment = (isOpen) => {
            state.isPaymentOpen = isOpen;
            if(!isOpen) state.isCheckoutOpen = true; 
            render();
        }

        window.toggleConfirmation = (isOpen) => {
            state.isConfirmationOpen = isOpen;
            if (isOpen) { state.isCheckoutOpen = false; } else { state.isCheckoutOpen = true; }
            render();
        };

        function calculateTab(tableNum) {
            const openOrders = state.orders.filter(o => o.tableNumber === tableNum && o.paymentStatus === 'pay_later' && o.status !== 'cancelled');
            return openOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        }

        function getAllPendingTabs() {
            const open = state.orders.filter(o => o.paymentStatus === 'pay_later' && o.status !== 'cancelled' && o.tableNumber);
            const byTable = {};
            open.forEach(o => {
                const t = String(o.tableNumber);
                if (!byTable[t]) byTable[t] = { table: t, total: 0, count: 0 };
                byTable[t].total += (o.total || 0);
                byTable[t].count += 1;
            });
            return Object.values(byTable).sort((a, b) => Number(a.table) - Number(b.table));
        }

        window.setTableNumber = (num) => {
            state.tableNumber = num;
            const openOrders = state.orders.filter(o => o.tableNumber === num && o.paymentStatus === 'pay_later' && o.status !== 'cancelled');
            state.tabTotal = openOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const pendingBillCount = openOrders.length; 

            const btn = document.getElementById('confirmBtn');
            const hasCartItems = state.cart.length > 0;
            const hasTab = state.tabTotal > 0;
            
            if (btn) {
                const canProceed = num && (hasCartItems || hasTab);
                btn.disabled = !canProceed;
                if (canProceed) btn.classList.remove('opacity-50', 'cursor-not-allowed');
                else btn.classList.add('opacity-50', 'cursor-not-allowed');
                
                const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const grandTotal = cartTotal + state.tabTotal;
                
                const priceSpan = btn.querySelector('span:last-child');
                if (priceSpan) priceSpan.textContent = `RM ${grandTotal.toFixed(2)}`;
                
                const textSpan = btn.querySelector('span:first-child');
                if (textSpan) {
                    if (hasTab && !hasCartItems) textSpan.textContent = "Settle Bill";
                    else if (hasTab && hasCartItems) textSpan.textContent = "Pay & Order";
                    else textSpan.textContent = "Review Order";
                }
            }
            
            const emptyMsg = document.getElementById('emptyCartMsg');
            if (emptyMsg) {
                if (hasTab && !hasCartItems) emptyMsg.classList.add('hidden');
                else if (!hasTab && !hasCartItems) emptyMsg.classList.remove('hidden');
            }

            const tabContainer = document.getElementById('tabInfoContainer');
            if (tabContainer) {
                if (hasTab) {
                    const aggregated = {};
                    openOrders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(i => {
                                const k = i.name + (i.variant || '');
                                if(!aggregated[k]) aggregated[k] = { ...i, quantity: 0, total: 0 };
                                aggregated[k].quantity += i.quantity;
                                aggregated[k].total += (i.price * i.quantity);
                            });
                        }
                    });
                    
                    const itemsHtml = Object.values(aggregated).map(i => `
                        <div class="flex justify-between text-xs text-gray-600 border-b border-blue-100 last:border-0 py-2">
                            <span class="flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-800 w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-bold">${i.quantity}</span>
                                <span>${i.name} ${i.variant ? `(${i.variant})` : ''}</span>
                            </span>
                            <span class="font-medium">RM ${i.total.toFixed(2)}</span>
                        </div>
                    `).join('');

                    tabContainer.innerHTML = `
                        <div class="mt-4 bg-blue-50 border border-blue-100 rounded-xl overflow-hidden animate-fade-in">
                            <div class="p-3 bg-blue-100/50 flex justify-between items-center">
                                <span class="text-blue-800 font-bold text-sm">Previous Orders (Tab)</span>
                                <span class="text-xs bg-white px-2 py-0.5 rounded-full text-blue-600 font-bold border border-blue-200">${pendingBillCount} Pending Bill${pendingBillCount > 1 ? 's' : ''}</span>
                            </div>
                            <div class="p-3 bg-white/50">
                                ${itemsHtml}
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-blue-200 font-bold text-blue-900 text-sm">
                                    <span>Tab Total</span>
                                    <span>RM ${state.tabTotal.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2 text-lg font-bold text-gray-900 border-t pt-4 mt-4">
                            <span>Total Due:</span>
                            <span>RM ${(state.cart.reduce((s,i)=>s+(i.price*i.quantity),0) + state.tabTotal).toFixed(2)}</span>
                        </div>
                    `;
                    tabContainer.classList.remove('hidden');
                } else {
                    tabContainer.innerHTML = '';
                    tabContainer.classList.add('hidden');
                }
            }
        };

        window.selectPendingTable = (tableNum) => {
            state.tableNumber = String(tableNum);
            render();
            setTimeout(() => {
                const input = document.getElementById('tableNumberInput');
                if (input) input.value = String(tableNum);
                setTableNumber(String(tableNum));
            }, 50);
        };

        window.enterDemoMode = () => {
            state.isDemoMode = true;
            state.error = null;
            state.view = 'landing';
            setupDataListeners(); 
        };

        // --- Admin Actions ---

        window.handleAddCategory = async (e) => {
            e.preventDefault();
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            const basePath = "artifacts/ooru-mess-github/public/data";
            await addDoc(collection(db, basePath, "categories"), {
                name: name,
                order: state.categories.length + 1
            });
            document.getElementById('newCatName').value = '';
        };

        window.handleAddItem = async (e) => {
            e.preventDefault();
            const name = document.getElementById('itemName').value;
            const variant = document.getElementById('itemVariant').value;
            const price = parseFloat(document.getElementById('itemPrice').value);
            const category = document.getElementById('itemCategory').value;
            if(!name || !price || !category) return;
            const basePath = "artifacts/ooru-mess-github/public/data";
            await addDoc(collection(db, basePath, "menu"), { name, variant, price, category });
            document.getElementById('itemName').value = '';
            document.getElementById('itemVariant').value = '';
            document.getElementById('itemPrice').value = '';
            alert("Item Added Successfully!");
        };

        window.handleDeleteItem = async (id) => {
            if(!confirm("Are you sure you want to delete this item?")) return;
            const basePath = "artifacts/ooru-mess-github/public/data";
            await deleteDoc(doc(db, basePath, "menu", id));
        };

        window.toggleAdminCategory = (catName) => {
            state.adminExpandedCategories[catName] = !state.adminExpandedCategories[catName];
            render();
        }

        // --- Order & Payment Logic ---

        window.initiatePayment = () => {
             if (state.processingAction) return;
             if (!state.tableNumber) return;
             if (state.cart.length === 0 && state.tabTotal === 0) return;
             
             if (state.cart.length > 0) {
                 state.isCheckoutOpen = false;
                 state.isConfirmationOpen = true;
             } else {
                 state.isCheckoutOpen = false;
                 state.isPaymentOpen = true;
                 state.paymentStep = 'selection';
             }
             render();
        };

        window.proceedToPaymentSelection = () => {
            state.isConfirmationOpen = false;
            state.isPaymentOpen = true;
            state.paymentStep = 'selection';
            render();
        }

        window.showLargeQR = () => {
            state.paymentStep = 'qr_fullscreen';
            render();
            // Wait for DOM update then generate QR
            setTimeout(() => {
                const container = document.getElementById('qrcode');
                const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const grandTotal = cartTotal + state.tabTotal;
                
                if (container && state.duitNowBaseString) {
                    container.innerHTML = ''; // Clear previous
                    const dynamicString = generateDuitNowString(state.duitNowBaseString, grandTotal);
                    
                    if (dynamicString) {
                        new QRCode(container, {
                            text: dynamicString,
                            width: 200,
                            height: 200,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.M
                        });
                    } else {
                        container.innerHTML = '<p class="text-xs text-red-500 text-center">Invalid QR Configuration</p>';
                    }
                } else if (container) {
                    // Fallback if no string configured
                     container.innerHTML = '<img src="https://theva73.github.io/OoruMess/qrcode.png" class="w-full h-full object-contain" alt="QR Code">';
                }
            }, 100);
        }
        
        window.backToSelection = () => {
            state.paymentStep = 'selection';
            render();
        };

        window.confirmPayment = async (method) => {
            if (state.processingAction) return; // Guard against double click

            // Set loading state
            state.processingAction = method;
            render();

            try {
                const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                if (method === 'settle_tab_cash' || method === 'settle_tab_qr') {
                    const realMethod = method === 'settle_tab_cash' ? 'cash' : 'qr';
                    if (state.cart.length > 0) {
                        await createOrder('paid', realMethod, cartTotal);
                    }
                    if (!state.isDemoMode) {
                        const basePath = "artifacts/ooru-mess-github/public/data";
                        const q = query(
                            collection(db, basePath, "orders"), 
                            where("tableNumber", "==", state.tableNumber),
                            where("paymentStatus", "==", "pay_later")
                        );
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(docSnap => {
                            if (docSnap.data().status !== 'cancelled') {
                                batch.update(docSnap.ref, { paymentStatus: 'paid', paymentMethod: realMethod + '_tab_settled' });
                            }
                        });
                        await batch.commit();
                    } else {
                        state.orders.forEach(o => {
                            if (o.tableNumber === state.tableNumber && o.paymentStatus === 'pay_later') {
                                o.paymentStatus = 'paid';
                            }
                        });
                    }
                    alert(`Full Bill Settled! Table ${state.tableNumber} is now clear.`);
                    resetCart();
                } else if (method === 'pay_later') {
                    await createOrder('pay_later', 'pay_later', cartTotal);
                    alert(`Order added to Tab for Table ${state.tableNumber}. Kitchen notified!`);
                    resetCart();
                } else {
                    await createOrder(method === 'qr' ? 'paid' : 'unpaid', method, cartTotal); 
                    if (method === 'cash') {
                        alert(`Order Placed! Please pay RM ${cartTotal.toFixed(2)} at the counter.`);
                    } else {
                        alert(`Payment Received! Kitchen Notified.`);
                    }
                    resetCart();
                }
            } catch (e) {
                console.error("Payment Error:", e);
                alert("Processing Error: " + e.message + ". Please try again.");
            } finally {
                // Clear loading state
                state.processingAction = null;
                // Only re-render if we haven't reset the cart (which does its own render)
                // If resetCart() was called, the modal is closed anyway.
                // If error occurred, this render ensures the buttons are re-enabled.
                if (state.cart.length > 0 || state.tabTotal > 0) render();
            }
        };

        async function createOrder(paymentStatus, paymentMethod, total) {
            const orderData = {
                tableNumber: state.tableNumber,
                items: state.cart,
                total: total,
                status: 'pending', 
                paymentStatus: paymentStatus,
                paymentMethod: paymentMethod,
                timestamp: serverTimestamp(),
                userId: state.user ? state.user.uid : 'demo'
            };

            if (state.isDemoMode) {
                orderData.timestamp = { toDate: () => new Date() };
                orderData.id = 'demo-' + Date.now();
                state.orders.unshift(orderData);
                // Simulate network delay in demo mode
                await new Promise(r => setTimeout(r, 1500));
            } else {
                const basePath = "artifacts/ooru-mess-github/public/data";
                await addDoc(collection(db, basePath, "orders"), orderData);
            }
        }

        function resetCart() {
            state.cart = [];
            state.tableNumber = '';
            state.isCheckoutOpen = false;
            state.isConfirmationOpen = false;
            state.isPaymentOpen = false;
            state.tabTotal = 0;
            state.checkoutMode = 'cart';
            render();
        }

        window.updateOrderStatus = async (orderId, newStatus) => {
            if (state.isDemoMode) {
                const order = state.orders.find(o => o.id === orderId);
                if (order) order.status = newStatus;
                render();
                return;
            }
            try {
                const basePath = "artifacts/ooru-mess-github/public/data";
                const orderRef = doc(db, basePath, "orders", orderId);
                await updateDoc(orderRef, { status: newStatus });
            } catch (e) {
                console.error(e);
            }
        };

        // --- Render Functions ---

        function render() {
            const appEl = document.getElementById('app');
            
            if (state.error) {
                renderError(appEl);
                return;
            }

            if (state.loading) {
                appEl.innerHTML = `
                    <div class="h-dvh flex items-center justify-center flex-col text-orange-600">
                        <i data-lucide="loader-2" class="w-12 h-12 mb-4 animate-spin"></i>
                        <p class="font-bold">Loading Menu...</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let kdsScrollLeft = 0;
            if (state.view === 'kitchen') {
                const scrollContainer = document.getElementById('kds-container');
                if (scrollContainer) kdsScrollLeft = scrollContainer.scrollLeft;
            }

            if (state.view === 'landing') renderLanding(appEl);
            else if (state.view === 'customer') renderCustomer(appEl);
            else if (state.view === 'kitchen') renderKitchen(appEl);
            else if (state.view === 'admin') renderAdmin(appEl);
            
            lucide.createIcons();

            if (state.view === 'kitchen') {
                const scrollContainer = document.getElementById('kds-container');
                if (scrollContainer) {
                    scrollContainer.scrollLeft = kdsScrollLeft;
                }
            }
        }

        function renderError(container) {
            const isPermission = state.error?.code === 'permission-denied';
            const isProtocol = state.error?.code === 'protocol-error';
            
            container.innerHTML = `
            <div class="h-dvh bg-white flex flex-col items-center justify-center p-6 text-center">
                <div class="bg-red-50 p-6 rounded-2xl max-w-lg w-full border border-red-100 shadow-xl">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Setup Required</h2>
                    <p class="text-gray-600 mb-4">${state.error.message}</p>
                    ${isPermission ? `
                    <div class="text-left bg-gray-900 text-gray-300 p-4 rounded-lg text-xs font-mono overflow-x-auto mb-4">
                        <p class="text-green-400 mb-2">// Update Firebase Rules</p>
                        match /databases/{database}/documents { allow read, write: if true; }
                    </div>` : ''}
                    <div class="flex flex-col gap-3">
                        ${!isProtocol ? '<button onclick="window.location.reload()" class="bg-gray-800 text-white py-3 rounded-xl font-bold">Retry</button>' : ''}
                        <button onclick="enterDemoMode()" class="bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg">Enter Demo Mode</button>
                    </div>
                </div>
            </div>`;
        }

        function renderLanding(container) {
            let loginModal = '';
            if (state.isAdminLoginOpen) {
                loginModal = `
                <div class=\"fixed inset-0 bg-black/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4\">
                    <div class=\"bg-white w-full max-w-xs rounded-2xl shadow-2xl animate-slide-up p-6 text-center relative overflow-hidden\">
                        <button onclick=\"closeAdminLogin()\" class=\"absolute top-4 right-4 text-gray-400 hover:text-gray-600\"><i data-lucide=\"x\" class=\"w-5 h-5\"></i></button>
                        
                        <div class=\"mb-6 mt-2\">
                            <div class=\"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3\">
                                <i data-lucide=\"lock\" class=\"w-8 h-8 text-gray-600\"></i>
                            </div>
                            <h2 class=\"text-xl font-bold text-gray-800\">Admin Access</h2>
                            <p class=\"text-xs text-gray-500\">Please enter your PIN to continue</p>
                        </div>

                        <form onsubmit=\"handleAdminLogin(event)\" class=\"space-y-4\">
                            <div id=\"pinContainer\">
                                <input type=\"password\" id=\"adminPinInput\" placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\" maxlength=\"4\" class=\"w-full text-center text-3xl font-bold tracking-[1em] p-3 border rounded-xl outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all placeholder-gray-300\" autofocus>
                            </div>
                            
                            ${state.adminLoginError ? `<p class=\"text-xs text-red-500 font-bold animate-pulse\">${state.adminLoginError}</p>` : ''}
                            
                            <button type=\"submit\" class=\"w-full bg-gray-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg\">
                                Unlock
                            </button>
                        </form>
                    </div>
                </div>
                `;
            }

            container.innerHTML = `
                <div class=\"landing-screen p-6\">
                  <div class=\"landing-pattern\"></div>
                  <div class=\"absolute top-4 right-4 z-50\">
                    <button onclick=\"setView('admin')\" class=\"w-12 h-12 rounded-full bg-white/70 backdrop-blur-md shadow-lg border border-white/60 flex items-center justify-center\" title=\"Settings\">
                      <i data-lucide=\"settings\" class=\"w-6 h-6 text-gray-800\"></i>
                    </button>
                  </div>

                  <div class=\"landing-logo flex-1 flex items-center justify-center w-full\">
                    <img src=\"oorumess.png\" alt=\"Ooru Mess Logo\" class=\"max-w-[88vw] max-h-[56vh] object-contain drop-shadow-2xl\">
                  </div>

                  <div class=\"landing-actions w-full max-w-md space-y-4 mb-8\">
                    <button class=\"btn-3d btn-orange w-full py-4 text-white rounded-[999px] text-lg font-extrabold tracking-wide flex items-center justify-center gap-3\" onclick=\"setView('customer')\">
                        <span>Place Order</span>
                        <i data-lucide=\"utensils\" class=\"w-5 h-5\"></i>
                    </button>

                    <button class=\"btn-3d btn-green w-full py-4 text-white rounded-[999px] text-lg font-bold tracking-wide flex items-center justify-center gap-3\" onclick=\"setView('kitchen')\">
                        <span>Kitchen View</span>
                        <i data-lucide=\"chef-hat\" class=\"w-5 h-5\"></i>
                    </button>
                  </div>

                  ${state.isDemoMode ? '<div class=\"absolute top-6 left-6 bg-orange-900/80 text-white px-3 py-1 rounded-full text-xs font-bold border border-orange-400/50 pointer-events-none z-50\">DEMO MODE</div>' : ''}
                  ${loginModal}
                </div>
            `;
            
            if (state.isAdminLoginOpen) {
                setTimeout(() => document.getElementById('adminPinInput')?.focus(), 100);
            }
        }

        function renderAdmin(container) {
            const categories = state.categories.sort((a,b) => a.order - b.order);
            const menuItems = state.menuItems;

            const groupedMenuHtml = categories.map(cat => {
                const catItems = menuItems.filter(item => item.category === cat.name);
                const isExpanded = state.adminExpandedCategories[cat.name];
                
                return `
                    <div class="mb-4 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div onclick="toggleAdminCategory('${cat.name}')" class="p-4 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition select-none">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="chevron-${isExpanded ? 'down' : 'right'}" class="w-5 h-5 transition-transform text-gray-400"></i>
                                ${cat.name}
                            </h3>
                            <span class="text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full font-bold">${catItems.length}</span>
                        </div>
                        <div class="${isExpanded ? 'block' : 'hidden'} p-4 border-t border-gray-100 bg-white">
                            <div class="space-y-2">
                                ${catItems.length > 0 ? catItems.map(item => `
                                    <div class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 transition group">
                                        <div>
                                            <div class="font-semibold text-gray-800 text-sm">${item.name}</div>
                                            ${item.variant ? `<div class="text-xs text-gray-500">‚Ä¢ ${item.variant}</div>` : ''}
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="font-bold text-gray-900 text-sm">RM ${parseFloat(item.price).toFixed(2)}</span>
                                            <button onclick="handleDeleteItem('${item.id}')" class="text-gray-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded-full transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-xs text-gray-400 italic py-2 text-center">No items in this category.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const uncategorized = menuItems.filter(item => !categories.some(c => c.name === item.category));
            const uncategorizedHtml = uncategorized.length > 0 ? `
                <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-red-100">
                    <h3 class="font-bold text-red-800 mb-3 flex justify-between items-center border-b border-red-100 pb-2">
                        Uncategorized
                        <span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-bold">${uncategorized.length}</span>
                    </h3>
                    <div class="space-y-2">
                        ${uncategorized.map(item => `
                            <div class="flex justify-between items-center p-3 bg-red-50/50 rounded-lg">
                                <div>
                                    <div class="font-semibold text-gray-800 text-sm">${item.name}</div>
                                    <div class="text-xs text-gray-500 italic">Category: ${item.category} (Missing)</div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-bold text-gray-900 text-sm">RM ${parseFloat(item.price).toFixed(2)}</span>
                                    <button onclick="handleDeleteItem('${item.id}')" class="text-red-400 hover:text-red-600 p-1.5"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            container.innerHTML = `
                <div class="min-h-screen bg-gray-50 pb-20">
                    <div class="bg-slate-900 text-white p-4 sticky top-0 z-20 flex items-center justify-between shadow-md">
                        <div class="flex items-center gap-3">
                            <button onclick="setView('landing')" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <h1 class="font-bold text-xl">Admin Settings</h1>
                        </div>
                    </div>

                    <div class="max-w-4xl mx-auto p-4 space-y-6">
                        
                        <!-- Sales Dashboard Link Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                    <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="font-bold text-lg text-gray-800">Sales Dashboard</h2>
                                    <p class="text-xs text-gray-500">View analytics, revenue, and order trends</p>
                                </div>
                            </div>
                            <a href="https://theva73.github.io/OoruMess/SalesDashboard.html" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 flex items-center justify-center gap-2 transition transform active:scale-95">
                                Open Dashboard <i data-lucide="external-link" class="w-4 h-4"></i>
                            </a>
                        </div>
                        
                        <!-- DuitNow Configuration with Test Button -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-pink-500">
                            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="qr-code" class="w-5 h-5 text-pink-600"></i> Payment Configuration</h2>
                            <p class="text-sm text-gray-600 mb-4">
                                To enable <b>Dynamic QR</b> (auto-filled amount), scan your DuitNow QR using a text scanner app and paste the text content here.
                            </p>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="duitNowInput" value="${state.duitNowBaseString}" placeholder="000201010211... (Paste long string here)" class="flex-1 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-pink-500 font-mono text-xs">
                                <button onclick="saveDuitNowString()" class="bg-pink-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-pink-700 shadow-lg shadow-pink-100">Save</button>
                            </div>
                            
                            <div class="border-t pt-4">
                                <h3 class="font-bold text-gray-800 mb-2 text-sm">Test QR Generation</h3>
                                <div class="flex gap-4 items-start">
                                    <button onclick="testDuitNowQR()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-900 text-sm">Generate Test QR (RM 1.00)</button>
                                    <div id="testQROutput" class="bg-white p-2 border rounded shadow-inner min-w-[100px] min-h-[100px] flex items-center justify-center text-xs text-gray-400">
                                        ${state.testQRString ? '' : 'QR will appear here'}
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 italic">Scan this test QR with your bank app. It should ask for RM 1.00.</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="layers" class="w-5 h-5 text-blue-600"></i> Manage Categories</h2>
                            <form onsubmit="handleAddCategory(event)" class="flex gap-2">
                                <input type="text" id="newCatName" placeholder="New Category Name (e.g. Desserts)" class="flex-1 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">Add</button>
                            </form>
                            <div class="flex flex-wrap gap-2 mt-4">
                                ${categories.map(c => `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100">${c.name}</span>`).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-green-600"></i> Add New Food Item</h2>
                            <form onsubmit="handleAddItem(event)" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="itemName" placeholder="Food Name (e.g. Ice Cream)" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500" required>
                                    <input type="text" id="itemVariant" placeholder="Variant (Optional - e.g. Vanilla)" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-gray-500">RM</span>
                                        <input type="number" id="itemPrice" step="0.10" placeholder="0.00" class="p-3 pl-10 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <select id="itemCategory" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="" disabled selected>Select Category</option>
                                        ${categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-100">Add to Menu</button>
                            </form>
                        </div>

                        <div>
                            <h2 class="font-bold text-xl mb-4 flex items-center gap-2"><i data-lucide="list" class="w-5 h-5 text-orange-600"></i> Current Menu</h2>
                            ${groupedMenuHtml}
                            ${uncategorizedHtml}
                        </div>

                    </div>
                </div>
            `;
            
            if (state.testQRString) {
                setTimeout(() => {
                    const container = document.getElementById('testQROutput');
                    if (container && container.innerHTML.includes('QR will appear here')) {
                         container.innerHTML = '';
                        new QRCode(container, { text: state.testQRString, width: 150, height: 150 });
                    }
                }, 100);
            }
        }

        function renderCustomer(container) {
            if (!state.activeCategory && state.categories.length > 0) {
                state.activeCategory = state.categories[0].name;
            }

            const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const cartCount = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            const visibleItems = state.menuItems.filter(item => item.category === state.activeCategory);

            const itemsHtml = visibleItems.map(item => {
                const inCart = state.cart.find(c => c.id === item.id);
                const countBadge = inCart ? `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md z-10 animate-bounce-short">${inCart.quantity}</div>` : '';
                const activeClass = inCart ? 'ring-2 ring-orange-500 bg-orange-50' : 'bg-white hover:shadow-md';

                return `
                <div class="relative group">
                    ${countBadge}
                    <div class="item-btn p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-full ${activeClass} cursor-pointer select-none" onclick="${!inCart ? `addToCart('${item.id}')` : ''}">
                        <div class="mb-2">
                            <h3 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2">${item.name}</h3>
                            ${item.variant ? `<p class="text-[10px] text-gray-500 mt-0.5 font-medium uppercase tracking-wide">${item.variant}</p>` : ''}
                        </div>
                        <div class="flex justify-between items-end mt-auto">
                            <span class="font-bold text-base text-gray-900">RM ${parseFloat(item.price).toFixed(2)}</span>
                            ${inCart ? `
                                <div class="flex items-center bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden" onclick="event.stopPropagation()">
                                    <button onclick="updateQuantity('${item.id}', -1)" class="px-2 py-1 hover:bg-red-50 text-red-600 transition"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                    <button onclick="updateQuantity('${item.id}', 1)" class="px-2 py-1 hover:bg-green-50 text-green-600 transition border-l border-gray-100"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                </div>
                            ` : `
                                <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </div>
                            `}
                        </div>
                    </div>
                </div>`;
            }).join('');

            const tabsHtml = state.categories.sort((a,b) => a.order - b.order).map(cat => `
                <button onclick="setCategory('${cat.name}')" 
                    class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide whitespace-nowrap transition-all transform active:scale-95 ${
                        state.activeCategory === cat.name
                        ? 'bg-orange-600 text-white shadow-md shadow-orange-200' 
                        : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'
                    }">
                    ${cat.name}
                </button>
            `).join('');

            let modalHtml = '';
            if (state.isCheckoutOpen) {
                const cartItemsHtml = state.cart.map(item => `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg mb-2">
                        <div>
                            <div class="font-semibold text-gray-800 text-sm">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.variant}</div>
                            <div class="text-xs font-bold text-orange-600 mt-1">RM ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                        <div class="flex items-center gap-2 bg-white border rounded px-2 py-1 shadow-sm">
                            <button onclick="updateQuantity('${item.id}', -1)" class="text-red-500"><i data-lucide="minus" class="w-3 h-3"></i></button>
                            <span class="text-xs font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity('${item.id}', 1)" class="text-green-500"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `).join('');

                const grandTotal = cartTotal + state.tabTotal;

                modalHtml = `
                <div class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
                    <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl max-h-[90vh] flex flex-col shadow-2xl animate-slide-up">
                        <div class="p-4 border-b flex justify-between items-center bg-orange-50 sm:rounded-t-2xl">
                            <h2 class="font-bold flex items-center gap-2 text-lg"><i data-lucide="shopping-bag" class="w-5 h-5 text-orange-600"></i> Your Order</h2>
                            <button onclick="toggleCheckout(false)" class="p-2 hover:bg-white rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-4 overflow-y-auto flex-1">
                            ${state.cart.length ? cartItemsHtml : '<p id="emptyCartMsg" class="text-center text-gray-400 py-10 flex flex-col items-center"><i data-lucide="shopping-cart" class="w-8 h-8 mb-2 opacity-50"></i>Cart is empty</p>'}
                            
                            <div class="mt-4 pt-4 border-t border-dashed border-gray-300">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Table Number <span class="text-red-500">*</span></label>
                                <input id="tableNumberInput" type="number" oninput="setTableNumber(this.value)" value="${state.tableNumber}" placeholder="e.g. 5" class="w-full p-3 border rounded-xl text-center text-2xl font-bold outline-none focus:ring-2 focus:ring-orange-500 bg-gray-50 placeholder-gray-300">
                                <p class="text-xs text-center text-gray-400 mt-2">Enter number to check bill or place order</p>
                            </div>

                            ${(() => {
                                if (state.checkoutMode !== 'check_bill') return '';
                                const tabs = getAllPendingTabs();
                                if (!tabs.length) return '';
                                const totalAll = tabs.reduce((s, t) => s + t.total, 0);
                                const rows = tabs.map(t => {
                                    const isActive = state.tableNumber && String(state.tableNumber) === String(t.table);
                                    return `
                                        <button onclick="selectPendingTable('${t.table}')"
                                            class="w-full flex items-center justify-between p-3 rounded-xl border text-left transition ${isActive ? 'bg-orange-50 border-orange-200' : 'bg-white border-gray-200 hover:bg-gray-50'}">
                                            <div>
                                                <div class="font-bold text-gray-900">Table ${t.table}</div>
                                                <div class="text-xs text-gray-500">${t.count} pending bill${t.count > 1 ? 's' : ''}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-gray-900">RM ${t.total.toFixed(2)}</div>
                                                <div class="text-[11px] font-semibold text-orange-600">Tap to view</div>
                                            </div>
                                        </button>
                                    `;
                                }).join('');
                                return `
                                    <div class="mt-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Pending Bills</div>
                                            <div class="text-xs font-bold text-gray-700">RM ${totalAll.toFixed(2)}</div>
                                        </div>
                                        <div class="space-y-2">${rows}</div>
                                        <p class="text-[11px] text-gray-400 text-center mt-2">Select a table to view and settle its bill.</p>
                                    </div>
                                `;
                            })()}

                            <div id="tabInfoContainer" class="hidden"></div>
                        </div>
                        <div class="p-4 border-t bg-gray-50 sm:rounded-b-2xl space-y-3">
                            <button id="confirmBtn" onclick="initiatePayment()" disabled class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg opacity-50 transition-opacity flex justify-center items-center gap-2 cursor-not-allowed">
                                <span>Proceed to Payment</span>
                                <span class="bg-white/20 px-2 py-0.5 rounded text-sm">RM ${(state.tabTotal > 0 ? grandTotal : cartTotal).toFixed(2)}</span>
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            let confirmationModalHtml = '';
            if(state.isConfirmationOpen) {
                const cartItemsSummary = state.cart.map(item => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <span class="bg-gray-100 text-gray-700 font-bold w-6 h-6 flex items-center justify-center rounded-full text-xs">${item.quantity}x</span>
                            <span class="text-sm font-medium text-gray-800">${item.name}</span>
                        </div>
                        <span class="text-sm font-bold text-gray-900">RM ${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `).join('');

                const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const grandTotal = cartTotal + state.tabTotal;

                let tabSummaryHtml = '';
                if (state.tabTotal > 0) {
                    const openOrders = state.orders.filter(o => o.tableNumber === state.tableNumber && o.paymentStatus === 'pay_later' && o.status !== 'cancelled');
                    const aggregated = {};
                    openOrders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(i => {
                                const k = i.name + (i.variant || '');
                                if(!aggregated[k]) aggregated[k] = { ...i, quantity: 0, total: 0 };
                                aggregated[k].quantity += i.quantity;
                                aggregated[k].total += (i.price * i.quantity);
                            });
                        }
                    });

                    tabSummaryHtml += `<div class="mb-2 pt-2 border-t border-gray-200 mt-2"><h3 class="font-bold text-blue-600 text-xs uppercase mb-2">Previous Unpaid Items</h3>`;
                    tabSummaryHtml += Object.values(aggregated).map(i => `
                        <div class="flex justify-between items-center py-1 text-gray-500">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-50 text-blue-700 font-bold w-5 h-5 flex items-center justify-center rounded-full text-[10px]">${i.quantity}x</span>
                                <span class="text-xs font-medium">${i.name}</span>
                            </div>
                            <span class="text-xs font-bold">RM ${i.total.toFixed(2)}</span>
                        </div>
                    `).join('');
                    tabSummaryHtml += `</div>`;
                }

                confirmationModalHtml = `
                <div class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
                    <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl animate-slide-up p-6">
                        <div class="text-center mb-6">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="check-circle-2" class="w-6 h-6 text-orange-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900">Review Bill</h2>
                            <p class="text-xs text-gray-500">Table ${state.tableNumber}</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 mb-6 max-h-80 overflow-y-auto">
                            ${state.cart.length > 0 ? `<h3 class="font-bold text-orange-600 text-xs uppercase mb-2">Current Order</h3>${cartItemsSummary}` : ''}
                            ${tabSummaryHtml}
                            <div class="flex justify-between items-center mt-3 pt-3 border-t-2 border-dashed border-gray-300">
                                <span class="font-bold text-gray-800 text-lg">Total Due</span>
                                <span class="font-bold text-xl text-green-600">RM ${grandTotal.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="proceedToPaymentSelection()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg shadow-green-100 transition flex items-center justify-center gap-2">
                                Confirm & Pay
                            </button>
                            <button onclick="toggleConfirmation(false)" class="w-full bg-white border border-gray-200 text-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-50 transition">
                                Back to Edit
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            let paymentModalHtml = '';
            if(state.isPaymentOpen) {
                const cartTotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const grandTotal = cartTotal + state.tabTotal;
                const isTabActive = state.tabTotal > 0;

                if (state.paymentStep === 'selection') {
                    paymentModalHtml = `
                    <div class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
                        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl animate-slide-up p-6 text-center">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-900">Choose Payment</h2>
                                <button onclick="togglePayment(false)" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                            </div>
                            <div class="space-y-4 ${state.processingAction ? 'opacity-50 pointer-events-none' : ''}">
                                <div class="border rounded-xl p-4 hover:border-blue-500 transition cursor-pointer group bg-blue-50 border-blue-100" onclick="confirmPayment('pay_later')">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-200 transition">
                                        <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                                    </div>
                                    <h3 class="font-bold text-gray-800">Pay Later (Add to Tab)</h3>
                                    <p class="text-xs text-gray-500">Send to kitchen & pay total later</p>
                                </div>
                                <div class="relative flex py-2 items-center">
                                    <div class="flex-grow border-t border-gray-200"></div>
                                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase font-bold">OR Settle Now</span>
                                    <div class="flex-grow border-t border-gray-200"></div>
                                </div>
                                <div class="border rounded-xl p-4 hover:border-orange-500 transition cursor-pointer group" onclick="showLargeQR()">
                                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-orange-200 transition">
                                        <i data-lucide="qr-code" class="w-6 h-6 text-orange-600"></i>
                                    </div>
                                    <h3 class="font-bold text-gray-800">Scan QR / DuitNow</h3>
                                    <div class="mt-2 bg-gray-50 p-2 rounded border border-dashed border-gray-300">
                                        <p class="text-[10px] text-gray-400 mt-1 font-bold">Pay RM ${grandTotal.toFixed(2)}</p>
                                    </div>
                                </div>
                                <div class="border rounded-xl p-4 hover:border-green-500 transition cursor-pointer group" onclick="${isTabActive ? `confirmPayment('settle_tab_cash')` : `confirmPayment('cash')`}">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-green-200 transition">
                                        <i data-lucide="banknote" class="w-6 h-6 text-green-600"></i>
                                    </div>
                                    <h3 class="font-bold text-gray-800">Cash at Counter</h3>
                                    <p class="text-xs text-gray-500">Settle Full Bill: RM ${grandTotal.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                } else if (state.paymentStep === 'qr_fullscreen') {
                    paymentModalHtml = `
                    <div class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center backdrop-blur-md p-4">
                        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl animate-slide-up overflow-hidden relative">
                            <div class="bg-orange-600 p-6 text-white text-center relative overflow-hidden">
                                <div class="absolute inset-0 bg-orange-700 opacity-20 transform -skew-y-12 scale-150"></div>
                                <h2 class="text-2xl font-bold relative z-10 mb-1">Scan to Pay</h2>
                                <p class="text-orange-100 text-sm relative z-10">Total Amount</p>
                                <p class="text-3xl font-bold relative z-10">RM ${grandTotal.toFixed(2)}</p>
                            </div>
                            
                            <div class="p-8 flex flex-col items-center">
                                <div class="w-64 h-64 bg-white p-2 rounded-xl shadow-lg border-2 border-orange-100 mb-6 relative group">
                                    <div class="absolute -inset-1 rounded-2xl border-2 border-dashed border-orange-300 animate-pulse"></div>
                                    <div id="qrcode" class="w-full h-full bg-white flex items-center justify-center relative z-10 p-2"></div>
                                </div>
                                <p class="text-sm text-gray-500 text-center mb-6 max-w-[200px]">Open your banking app or e-wallet to scan this DuitNow QR code.</p>
                                <div class="w-full space-y-3 ${state.processingAction ? 'opacity-50 pointer-events-none' : ''}">
                                    <button onclick="${isTabActive ? `confirmPayment('settle_tab_qr')` : `confirmPayment('qr')`}" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-100 transform active:scale-95 transition flex items-center justify-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                        I have Paid
                                    </button>
                                    <button onclick="backToSelection()" class="w-full bg-white border border-gray-200 text-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-50 transition">
                                        Back
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }
            }

            // --- GLOBAL LOADING OVERLAY ---
            let loadingOverlay = '';
            if (state.processingAction) {
                loadingOverlay = `
                <div class="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center backdrop-blur-sm animate-fade-in">
                    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-slide-up max-w-[80vw]">
                        <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full animate-spin mb-4"></div>
                        <h3 class="font-bold text-gray-800 text-lg">Processing...</h3>
                        <p class="text-xs text-gray-500 text-center">Please wait while we verify your order.</p>
                    </div>
                </div>`;
            }

            let floatingCart = '';
            if (cartCount > 0 && !state.isCheckoutOpen && !state.isPaymentOpen && !state.isConfirmationOpen) {
                floatingCart = `
                <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
                    <div class="max-w-4xl mx-auto flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">${cartCount} Items</p>
                            <p class="text-xl font-bold text-gray-900">Total: RM ${cartTotal.toFixed(2)}</p>
                        </div>
                        <button onclick="toggleCheckout(true, 'cart')" class="bg-orange-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-orange-700 transition transform active:scale-95">View Cart</button>
                    </div>
                </div>`;
            } else if (!state.isCheckoutOpen && !state.isPaymentOpen && !state.isConfirmationOpen) {
                 floatingCart = `
                <div class="fixed bottom-4 right-4 z-30">
                    <button onclick="toggleCheckout(true, 'check_bill')" class="bg-white border border-gray-200 text-gray-600 p-3 rounded-full shadow-lg flex items-center gap-2 font-bold text-sm hover:bg-gray-50 transition">
                        <i data-lucide="receipt" class="w-5 h-5"></i> Check Bill
                    </button>
                </div>`;
            }

            container.innerHTML = `
                <div class="pb-28">
                    <div class="bg-white sticky top-0 z-20 px-4 py-3 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button onclick="setView('landing')" class="text-gray-500 hover:text-black p-1 rounded hover:bg-gray-100"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div>
                                <h1 class="font-bold text-lg leading-tight">Ooru Mess</h1>
                                <p class="text-xs text-gray-500">Digital Menu</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             ${state.isDemoMode ? '<span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded border border-orange-200">DEMO</span>' : ''}
                             <div class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 border border-green-200">
                                <div class="w-2 h-2 ${state.isDemoMode ? 'bg-orange-500' : 'bg-green-500 animate-pulse'} rounded-full"></div> OPEN
                            </div>
                        </div>
                    </div>
                    <div class="bg-white sticky top-[58px] z-10 overflow-x-auto hide-scrollbar flex px-4 py-3 border-b gap-2">
                        ${tabsHtml}
                    </div>
                    <div class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                        ${itemsHtml.length ? itemsHtml : `<div class="col-span-full text-center py-10 text-gray-400">No items in this category yet.</div>`}
                    </div>
                    ${floatingCart}
                    ${modalHtml}
                    ${confirmationModalHtml}
                    ${paymentModalHtml}
                    ${loadingOverlay}
                </div>
            `;
        }

        function renderKitchen(container) {
            const isToday = (timestamp) => {
                if (!timestamp) return false;
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const today = new Date();
                return date.getDate() === today.getDate() &&
                       date.getMonth() === today.getMonth() &&
                       date.getFullYear() === today.getFullYear();
            };

            const todaysOrders = state.orders.filter(o => isToday(o.timestamp));
            const pendingOrders = todaysOrders.filter(o => o.status === 'pending');
            const cookingOrders = todaysOrders.filter(o => o.status === 'cooking');
            const readyOrders = todaysOrders.filter(o => ['ready', 'served'].includes(o.status)).slice(0, 5);

            const renderCard = (order, type) => {
                const timeStr = order.timestamp && order.timestamp.toDate ? order.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Now';
                
                let actions = '';
                if (type === 'pending') {
                    actions = `
                    <div class="flex gap-2 mt-3">
                        <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Cancel Order"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="updateOrderStatus('${order.id}', 'cooking')" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-bold text-sm hover:bg-orange-600 flex items-center justify-center gap-2 transition shadow"><i data-lucide="flame" class="w-4 h-4"></i> Preparing</button>
                    </div>`;
                } else if (type === 'cooking') {
                    actions = `
                    <div class="flex gap-2 mt-3">
                        <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Cancel Order"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="updateOrderStatus('${order.id}', 'ready')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-green-700 flex items-center justify-center gap-2 transition shadow"><i data-lucide="check-circle" class="w-4 h-4"></i> Mark Ready</button>
                    </div>`;
                } else if (type === 'ready' && order.status !== 'served') {
                    actions = `<button onclick="updateOrderStatus('${order.id}', 'served')" class="w-full mt-3 bg-gray-700 text-white py-2 rounded-lg font-bold text-sm hover:bg-gray-800 transition">Mark Served</button>`;
                }

                let displayStatus = order.status;
                if (order.status === 'cooking') displayStatus = 'PREPARING';
                
                const isPaid = order.paymentStatus === 'paid';
                let paymentBadge = '';
                
                if (order.paymentStatus === 'pay_later') {
                    paymentBadge = `<span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-0.5 rounded border border-blue-200 font-bold ml-1">TAB</span>`;
                } else if (isPaid) {
                    paymentBadge = `<span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded border border-green-200 font-bold ml-1">PAID</span>`;
                } else {
                    paymentBadge = `<span class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 font-bold ml-1">CASH</span>`;
                }

                return `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${type==='pending'?'border-blue-500':type==='cooking'?'border-orange-500':'border-green-500'} mb-4 animate-slide-up">
                    <div class="flex justify-between items-start mb-2 border-b pb-2">
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Table</span>
                            <div class="flex items-center gap-2">
                                <div class="text-3xl font-black text-gray-800 leading-none">${order.tableNumber}</div>
                                ${paymentBadge}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-medium text-gray-400 flex items-center justify-end gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${timeStr}</span>
                            <span class="text-xs font-bold uppercase px-2 py-0.5 rounded text-white mt-1 inline-block ${type==='pending'?'bg-blue-500':type==='cooking'?'bg-orange-500':'bg-green-500'}">${displayStatus}</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${order.items.map(i => `
                            <div class="flex gap-2 text-sm">
                                <span class="font-bold bg-gray-100 px-1.5 rounded h-fit text-gray-700">${i.quantity}x</span>
                                <div>
                                    <span class="font-medium text-gray-800">${i.name}</span>
                                    ${i.variant ? `<span class="text-xs text-gray-500 block">${i.variant}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${actions}
                </div>`;
            };

            container.innerHTML = `
                <div class="h-dvh bg-slate-100 flex flex-col">
                    <div class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
                        <div class="flex items-center gap-4">
                            <button onclick="setView('landing')" class="text-slate-400 hover:text-white transition"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <h1 class="text-xl font-bold flex items-center gap-2"><i data-lucide="chef-hat" class="text-orange-500"></i> KDS</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${state.isDemoMode ? 'bg-orange-500' : 'bg-green-500 pulse-status'}"></span>
                            <span class="text-xs font-mono text-slate-400 font-bold">${state.isDemoMode ? 'DEMO' : 'LIVE'}</span>
                        </div>
                    </div>
                    
                    <div id="kds-container" class="flex-1 overflow-x-auto p-4">
                        <div class="flex gap-4 min-w-[1000px]">
                            <div class="flex-1 min-w-[320px]">
                                <h2 class="font-bold text-slate-700 uppercase mb-4 flex justify-between items-center bg-slate-200/50 p-2 rounded-lg">
                                    <span>Pending</span> 
                                    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-bold">${pendingOrders.length}</span>
                                </h2>
                                ${pendingOrders.map(o => renderCard(o, 'pending')).join('') || '<div class="text-center text-slate-400 italic py-10 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50">No pending orders</div>'}
                            </div>
                            <div class="flex-1 min-w-[320px]">
                                <h2 class="font-bold text-slate-700 uppercase mb-4 flex justify-between items-center bg-slate-200/50 p-2 rounded-lg">
                                    <span>Preparing</span> 
                                    <span class="bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full text-xs font-bold">${cookingOrders.length}</span>
                                </h2>
                                ${cookingOrders.map(o => renderCard(o, 'cooking')).join('')}
                            </div>
                            <div class="flex-1 min-w-[320px]">
                                <h2 class="font-bold text-slate-700 uppercase mb-4 flex justify-between items-center bg-slate-200/50 p-2 rounded-lg">
                                    <span>Ready / Served</span> 
                                    <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-bold">${readyOrders.length}</span>
                                </h2>
                                ${readyOrders.map(o => renderCard(o, 'ready')).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>

